<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DGA Login Redirect</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 50px; }
        .loading { font-size: 20px; color: #666; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ê...</h1>
    <p id="message" class="loading">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>

    <script>
        async function autoLogin() {
            // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ mToken ‡πÅ‡∏•‡∏∞ appId ‡∏à‡∏≤‡∏Å URL
            const urlParams = new URLSearchParams(window.location.search);
            const mToken = urlParams.get('mToken');
            const appId = urlParams.get('appId');

            if (!mToken || !appId) {
                document.getElementById('message').innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö mToken ‡∏´‡∏£‡∏∑‡∏≠ appId";
                document.getElementById('message').className = "error";
                return;
            }

            try {
                // 2. ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡πâ Server C++ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                // ‡πÉ‡∏ä‡πâ ./ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á /test1/api... ‡πÅ‡∏•‡∏∞ /api... ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                const response = await fetch('./api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mToken, appId })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    if (data.type === 'REGISTER_NEEDED') {
                        // 3. ‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà -> ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Register
                        document.getElementById('message').innerText = "‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...";
                        document.getElementById('message').className = "success";
                        
                        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å DGA ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Register ‡∏î‡πâ‡∏ß‡∏¢ (‡∏ú‡πà‡∏≤‡∏ô Query String ‡∏´‡∏£‡∏∑‡∏≠ sessionStorage)
                        sessionStorage.setItem('dga_user', JSON.stringify(data.prefill_data));
                        setTimeout(() => window.location.href = './register', 1500);
                    } else {
                        // 4. ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ User ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß -> Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                        document.getElementById('message').innerText = `üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì ${data.user.firstname} ${data.user.lastname}`;
                        document.getElementById('message').className = "success";
                        console.log("User Data:", data.user);
                    }
                } else {
                    throw new Error(data.message || 'Login Failed');
                }
            } catch (error) {
                document.getElementById('message').innerText = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message;
                document.getElementById('message').className = "error";
            }
        }

        // ‡∏£‡∏±‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
        autoLogin();
    </script>
</body>
</html>